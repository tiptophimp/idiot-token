name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm install
          fi

      - name: Create deployment package
        run: |
          # Use the cleaned deployment files
          if [ -d "cleaned_deployment" ]; then
            cd cleaned_deployment
            zip -r ../deploy-package.zip . -x "*.git*" "*.DS_Store" "Thumbs.db"
          elif [ -d "01_LIVE_SITE/main_site" ]; then
            cd 01_LIVE_SITE/main_site
            zip -r ../../deploy-package.zip . -x "*.git*" "*.DS_Store" "Thumbs.db"
          else
            # Fallback to public_html if it exists
            if [ -d "public_html" ]; then
              cd public_html
              zip -r ../deploy-package.zip . -x "*.git*" "*.DS_Store" "Thumbs.db"
            else
              echo "No deployment directory found!"
              exit 1
            fi
          fi

      - name: Extract deployment package
        run: |
          unzip deploy-package.zip -d ./deploy-files/

      - name: Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deploy-files/
          server-dir: /public_html/
          protocol: ftp
          port: 21
          timeout: 300000
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/Thumbs.db
            **/*.log
        continue-on-error: true

      - name: Alternative SFTP Deploy (if FTP fails)
        if: failure()
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deploy-files/
          server-dir: /public_html/
          protocol: sftp
          port: 22
          timeout: 300000
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/Thumbs.db
            **/*.log
        continue-on-error: true

      - name: Manual Upload Instructions (if both fail)
        if: failure()
        run: |
          echo "üö® Both FTP and SFTP failed. Manual upload required."
          echo "üì¶ Download the deployment package from the artifacts section"
          echo "üåê Upload manually to Hostinger File Manager:"
          echo "   - Go to: https://hpanel.hostinger.com/file-manager"
          echo "   - Navigate to: /public_html/"
          echo "   - Upload and extract: stupidiots-deploy-${{ github.run_number }}.zip"
          echo "   - Move files from extracted folder to /public_html/ root"

      - name: Upload deployment package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: stupidiots-deploy-${{ github.run_number }}
          path: deploy-package.zip
          retention-days: 30

      - name: Deployment Status
        run: |
          echo "üöÄ Deployment completed!"
          echo "üì¶ Package: deploy-package.zip"
          echo "üåê Site: https://stupidiots.com"
          echo "üìä Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

