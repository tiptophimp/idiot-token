name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm install
          fi

      - name: Create deployment package
        run: |
          # Use the cleaned deployment files
          if [ -d "cleaned_deployment" ]; then
            cd cleaned_deployment
            zip -r ../deploy-package.zip . -x "*.git*" "*.DS_Store" "Thumbs.db"
          elif [ -d "01_LIVE_SITE/main_site" ]; then
            cd 01_LIVE_SITE/main_site
            zip -r ../../deploy-package.zip . -x "*.git*" "*.DS_Store" "Thumbs.db"
          else
            # Fallback to public_html if it exists
            if [ -d "public_html" ]; then
              cd public_html
              zip -r ../deploy-package.zip . -x "*.git*" "*.DS_Store" "Thumbs.db"
            else
              echo "No deployment directory found!"
              exit 1
            fi
          fi

      - name: Extract deployment package
        run: |
          unzip deploy-package.zip -d ./deploy-files/

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H us-bos-web1384.main-hosting.eu >> ~/.ssh/known_hosts

      - name: Deploy via SFTP/SSH
        run: |
          rsync -avz --delete ./deploy-files/ u939125353@us-bos-web1384.main-hosting.eu:/home/u939125353/domains/stupidiots.com/public_html/

      - name: Upload deployment package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: stupidiots-deploy-${{ github.run_number }}
          path: deploy-package.zip
          retention-days: 30

      - name: Deployment Status
        run: |
          echo "ğŸš€ Deployment completed!"
          echo "ğŸ“¦ Package: deploy-package.zip"
          echo "ğŸŒ Site: https://stupidiots.com"
          echo "ğŸ“Š Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

